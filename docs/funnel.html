<!DOCTYPE html>

<html>
<head>
  <title>funnel.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>funnel.coffee</h1>
        

        
      </div>

      
        
        <h2>The Funnel Class</h2>

        
      
        
        <p>This is where the API and some of the setup for the rules live.</p>

        
          <div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Funnel</span></span>
  constructor: ( rules ) -&gt;
    rules.<span class="function"><span class="title">input</span></span> = (arg) -&gt;
      <span class="property">@return</span> arg
    <span class="keyword">for</span> name, fn <span class="keyword">of</span> rules
      rule = <span class="keyword">new</span> <span class="property">@Rule</span>( name, fn )
      @[name] = ( args... ) -&gt; rule.run( args )
    <span class="property">@Rule</span>.compile_all()
    <span class="keyword">return</span>

  listen: ( fn ) =&gt;
    key = <span class="string">"_<span class="subst">#{Object.keys(@Rule._rules).length}</span>"</span>
    <span class="keyword">new</span> <span class="property">@Rule</span>(key, fn)
    <span class="property">@Rule</span>.compile_all()</pre></div>
        
      
        
        <h2>The Rule Class</h2>

        
      
        
        <p>The rule class is a singleton that is created for every new
rule definition. It computes and maintains information that
is essential for the Funnel runtime.</p>

        
          <div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Funnel</span>:</span>:Rule</pre></div>
        
      
        
        <p>Get a rule that is already defined</p>

        
          <div class='highlight'><pre>  <span class="property">@get</span>: ( name ) -&gt; <span class="property">@_rules</span>[name]</pre></div>
        
      
        
        <p>Allow other rules to register dependencies</p>

        
          <div class='highlight'><pre>  <span class="property">@on</span>: ( dependencies, rule ) -&gt;
    [min,d] = [Infinity, <span class="literal">undefined</span>]
    <span class="keyword">for</span> dependency <span class="keyword">in</span> dependencies
      n = dependency.passes(dependencies)
      <span class="keyword">if</span> n &gt; -<span class="number">1</span> <span class="keyword">and</span> n &lt; min
        min = n
        d = dependency
    d.bind( rule ) <span class="keyword">if</span> min &gt; -<span class="number">1</span> <span class="keyword">and</span> min &lt; Infinity</pre></div>
        
      
        
        <p>Clear all the rules to recompile</p>

        
          <div class='highlight'><pre>  <span class="property">@clear_all</span>: -&gt;
    <span class="keyword">for</span> name, rule <span class="keyword">of</span> <span class="property">@_rules</span>
      rule._dependencies = <span class="literal">undefined</span>
      rule._passes = <span class="literal">undefined</span>
      rule._bound = <span class="literal">undefined</span></pre></div>
        
      
        
        <p>Run the compile step</p>

        
          <div class='highlight'><pre>  <span class="property">@compile_all</span>: -&gt;
    <span class="property">@clear_all</span>()
    <span class="keyword">for</span> name, rule <span class="keyword">of</span> <span class="property">@_rules</span>
      <span class="property">@on</span>( rule.dependencies(), rule )</pre></div>
        
      
        
        <p>Construct a new rule
and save it as a singleton</p>

        
          <div class='highlight'><pre>  constructor: ( <span class="property">@name</span>, <span class="property">@_fn</span> ) -&gt;
    <span class="property">@constructor</span>._rules ?= {}
    <span class="property">@constructor</span>._rules[<span class="property">@name</span>] = <span class="keyword">this</span></pre></div>
        
      
        
        <p>Get the rules dependancies from the function&#39;s code
and store it for later</p>

        
          <div class='highlight'><pre>  dependencies: =&gt;
    <span class="keyword">unless</span> <span class="property">@_dependencies</span>?
      fnStr = <span class="property">@_fn</span>.toString()
      params = fnStr.slice(fnStr.indexOf(<span class="string">'('</span>)+<span class="number">1</span>, fnStr.indexOf(<span class="string">')'</span>))
      params = params.match(<span class="regexp">/([^\s,]+)/g</span>)
      <span class="keyword">if</span> params
        <span class="property">@_dependencies</span> = (<span class="property">@constructor</span>.get(p) <span class="keyword">for</span> p <span class="keyword">in</span> params)
      <span class="property">@_dependencies</span> = [] <span class="keyword">if</span> !<span class="property">@_dependencies</span>? <span class="keyword">or</span> <span class="literal">undefined</span> <span class="keyword">in</span> <span class="property">@_dependencies</span>
    <span class="keyword">return</span> <span class="property">@_dependencies</span></pre></div>
        
      
        
        <p>Get a list of all the dependencies that will be satisfied
after this function is called, optionally pass a list of
dependencies to check against this list</p>

        
          <div class='highlight'><pre>  passes: ( dependencies=<span class="literal">undefined</span> ) =&gt;
    <span class="keyword">unless</span> <span class="property">@_passes</span>
      <span class="property">@_passes</span> = []
      <span class="keyword">for</span> d <span class="keyword">in</span> <span class="property">@dependencies</span>()
        <span class="property">@_passes</span>.push(d)
        <span class="property">@_passes</span>.concat(d.passes())
      <span class="property">@_passes</span>.push(@)
    <span class="keyword">return</span> <span class="property">@_passes</span> <span class="keyword">unless</span> dependencies?</pre></div>
        
      
        
        <p>Check if dependancies are passed</p>

        
          <div class='highlight'><pre>    <span class="keyword">return</span> -<span class="number">1</span> <span class="keyword">if</span> <span class="property">@_passes</span>.length <span class="keyword">is</span> <span class="number">0</span>
    <span class="keyword">for</span> dependency <span class="keyword">in</span> dependencies
      <span class="keyword">return</span> -<span class="number">1</span> <span class="keyword">unless</span> dependency <span class="keyword">in</span> <span class="property">@_passes</span>
    <span class="keyword">return</span> <span class="property">@_passes</span>.length</pre></div>
        
      
        
        <p>Allow rules to bind to this rule&#39;s completion</p>

        
          <div class='highlight'><pre>  bind: ( rule ) =&gt;
    <span class="property">@_bound</span> ?= []
    <span class="property">@_bound</span>.push(rule)</pre></div>
        
      
        
        <p>Run this rule and trigger the next ones</p>

        
          <div class='highlight'><pre>  run: ( args ) =&gt;</pre></div>
        
      
        
        <p>Accept either a result hash or an argument list</p>

        
          <div class='highlight'><pre>    results = <span class="literal">undefined</span>
    d = <span class="property">@dependencies</span>()
    <span class="keyword">if</span> args
      <span class="keyword">if</span> Object::toString.call(args) == <span class="string">'[object Array]'</span>
        results = {}
        results[name] = args[i] <span class="keyword">for</span> name, i <span class="keyword">in</span> d
      <span class="keyword">else</span>
        results = args
        args = (args[x.name] <span class="keyword">for</span> x <span class="keyword">in</span> d)</pre></div>
        
      
        
        <p>Create the run context</p>

        
          <div class='highlight'><pre>    context =
      <span class="keyword">return</span>: (val) =&gt;
        results_ = JSON.parse(JSON.stringify(results))
        results_[ <span class="property">@name</span> ] = val
        <span class="property">@_bound</span> ?= []
        rule.run( results_ ) <span class="keyword">for</span> rule <span class="keyword">in</span> <span class="property">@_bound</span></pre></div>
        
      
        
        <p>Run the rule</p>

        
          <div class='highlight'><pre>    <span class="property">@_fn</span>.apply( context, args )</pre></div>
        
      
        
        <h3>Helpers</h3>

        
          <div class='highlight'><pre>Array::<span class="function"><span class="title">remove</span></span> = (object) -&gt; <span class="property">@splice</span>(<span class="property">@indexOf</span>(object), <span class="number">1</span>)
Array::<span class="function"><span class="title">clone</span></span> = -&gt; @[..]</pre></div>
        
      
        
        <h3>Export Funnel</h3>

        
          <div class='highlight'><pre><span class="property">@Funnel</span> = Funnel
module?.exports = Funnel</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
