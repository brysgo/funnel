<!DOCTYPE html>

<html>
<head>
  <title>The Rule Class</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          
          <h1>The Rule Class</h1>
<p>The rule class is a singleton that is created for every new
rule definition. It computes and maintains information that
is essential for the Funnel runtime.</p>

          
            <div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Rule</span></span></pre></div>
          
        

        
      </div>

      
        
        <p>Get a rule that is already defined</p>

        
          <div class='highlight'><pre>  <span class="property">@get</span>: ( <span class="property">@_name</span> ) -&gt; Rule._rules[<span class="property">@_name</span>]</pre></div>
        
      
        
        <p>Construct a new rule
and save it as a singleton</p>

        
          <div class='highlight'><pre>  constructor: ( <span class="property">@_name</span>, <span class="property">@_fn</span> ) -&gt;
    Rule._rules ?= {}
    <span class="keyword">if</span> <span class="property">@_name</span> <span class="keyword">of</span> Rule._rules
      <span class="keyword">throw</span> <span class="string">"FUNNEL ERROR: Rules can only be defined once"</span>
    <span class="keyword">else</span>
      Rule._rules[<span class="property">@_name</span>] = <span class="keyword">this</span></pre></div>
        
      
        
        <p>Get the rules dependancies from the function&#39;s code
and store it for later</p>

        
          <div class='highlight'><pre>  dependencies: =&gt;
    <span class="keyword">unless</span> <span class="property">@_dependencies</span>?
      reg = <span class="regexp">/\(([\s\S]*?)\)/</span>
      params = reg.exec(<span class="property">@fn</span>)
      <span class="property">@_dependencies</span> = params[<span class="number">1</span>].split(<span class="regexp">/\s*,\s*/</span>) <span class="keyword">if</span> params
    <span class="keyword">return</span> <span class="property">@_dependencies</span></pre></div>
        
      
        
        <p>Get a list of all the dependencies that will be satisfied
after this function is called</p>

        
          <div class='highlight'><pre>  passes: =&gt;
    <span class="keyword">unless</span> <span class="property">@_passes</span>
      <span class="property">@_passes</span> = []
      <span class="keyword">for</span> d <span class="keyword">in</span> <span class="property">@dependencies</span>
        <span class="property">@_passes</span>.append(d)
        d = Rule.get(d)
        <span class="property">@_passes</span>.concat(d.passes())
    <span class="keyword">return</span> <span class="property">@_passes</span></pre></div>
        
      
        
        <p>Get a list of all the rules who&#39;s dependencies are satisfied
by this rule</p>

        
          <div class='highlight'><pre>  satisfies: =&gt;</pre></div>
        
      
        
        <p>Run this rule and trigger the next ones</p>

        
          <div class='highlight'><pre>  run: =&gt;



<span class="class"><span class="keyword">class</span> <span class="title">Funnel</span></span>
  constructor: ( <span class="property">@rules</span> ) -&gt;
    <span class="property">@rules</span>.<span class="function"><span class="title">input</span></span> = (arg) -&gt; <span class="property">@return</span> arg
    <span class="property">@compile</span>()

  listen: ( fn ) =&gt;
    key = <span class="string">"_<span class="subst">#{Object.keys(@rules).length}</span>"</span>
    <span class="property">@rules</span>[key] = fn
    <span class="property">@compile</span>()

  compile: =&gt;
    <span class="property">@rules_by_lca</span> = {}
    <span class="keyword">for</span> name, fn <span class="keyword">of</span> <span class="property">@rules</span>
      @[name] = ( args... ) =&gt;
        deps = {}
        <span class="keyword">for</span> a,i <span class="keyword">in</span> <span class="property">@arg_names</span>( fn )
          deps[a] = args[i]
        <span class="property">@run</span>( name, deps )
      lca = <span class="property">@lca</span>( <span class="property">@arg_names</span>( fn )... )
      <span class="property">@rules_by_lca</span>[lca] ?= []
      <span class="property">@rules_by_lca</span>[lca].push(name)

  run: ( name, deps ) -&gt;
    ndeps = JSON.parse(JSON.stringify(deps))
    deps[ name ] ?= []
    a = <span class="property">@arg_names</span>( <span class="property">@rules</span>[ name ] )
    args = (deps[i] <span class="keyword">for</span> i <span class="keyword">in</span> a)
    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> <span class="literal">undefined</span> <span class="keyword">in</span> args
    rules_to_rerun = []
    context =
      <span class="keyword">return</span>: (val) =&gt;
        ndeps = JSON.parse(JSON.stringify(ndeps))
        ndeps[ name ] = val
        deps[ name ].push val
        <span class="keyword">for</span> n <span class="keyword">in</span> <span class="property">@rules_by_lca</span>[ name ] || []
          <span class="keyword">if</span> <span class="property">@run</span>( n, ndeps )
            deps.extend( ndeps )
          <span class="keyword">else</span>
            rules_to_rerun.push(n)


    <span class="property">@rules</span>[ name ].apply( context, args )
    <span class="property">@run</span>( n, deps ) <span class="keyword">for</span> n <span class="keyword">in</span> rules_to_rerun

    <span class="keyword">return</span> <span class="literal">true</span></pre></div>
        
      
        
        <h3>Helpers</h3>

        
          <div class='highlight'><pre>Array::<span class="function"><span class="title">remove</span></span> = (object) -&gt; <span class="property">@splice</span>(<span class="property">@indexOf</span>(object), <span class="number">1</span>)
Array::<span class="function"><span class="title">clone</span></span> = -&gt; @[..]
Object::<span class="function"><span class="title">extend</span></span> = (objects...) -&gt;
  <span class="keyword">for</span> object <span class="keyword">in</span> objects
    <span class="keyword">for</span> key, value <span class="keyword">of</span> object
      @[key] = value <span class="keyword">unless</span> @[key]?</pre></div>
        
      
        
        <h3>Export Funnel</h3>

        
          <div class='highlight'><pre><span class="property">@Funnel</span> = Funnel
module?.exports = Funnel</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
