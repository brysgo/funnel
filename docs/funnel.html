<!DOCTYPE html>

<html>
<head>
  <title>funnel.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>funnel.coffee</h1>
        

        
      </div>

      
        
        <h2>The Funnel Class</h2>

        
      
        
        <p>This is where the API and some of the setup for the rules live.</p>

        
          <div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Funnel</span></span>
  constructor: ( rules={} ) -&gt;
    <span class="property">@_rules</span> = {}
    rules.<span class="function"><span class="title">input</span></span> = (arg) -&gt;
      <span class="property">@emit</span> arg
    <span class="keyword">for</span> name, fn <span class="keyword">of</span> rules
      rule = <span class="property">@rule</span>(name, fn )
      @[name] = ( args... ) -&gt; rule.run( args )
    <span class="property">@compile</span>()
    <span class="keyword">return</span>
  
  listen: ( fn ) =&gt;
    key = <span class="string">"_<span class="subst">#{Object.keys(@_rules).length}</span>"</span>
    <span class="property">@rule</span>(key, fn)
    <span class="property">@compile</span>()</pre></div>
        
      
        
        <p>Allow other rules to register dependencies</p>

        
          <div class='highlight'><pre>  <span class="literal">on</span>: ( dependencies, rule ) -&gt;
    [min,d] = [Infinity, <span class="literal">undefined</span>]
    <span class="keyword">for</span> dependency <span class="keyword">in</span> dependencies
      n = dependency.passes(dependencies)
      <span class="keyword">if</span> n &gt; -<span class="number">1</span> <span class="keyword">and</span> n &lt; min
        min = n
        d = dependency
    d.bind( rule ) <span class="keyword">if</span> min &gt; -<span class="number">1</span> <span class="keyword">and</span> min &lt; Infinity</pre></div>
        
      
        
        <p>Compile current set of rules</p>

        
          <div class='highlight'><pre>  compile: -&gt;
    <span class="keyword">for</span> name, rule <span class="keyword">of</span> <span class="property">@_rules</span>
      rule.clear()
    <span class="keyword">for</span> name, rule <span class="keyword">of</span> <span class="property">@_rules</span>
      <span class="property">@on</span>( rule.dependencies(), rule )</pre></div>
        
      
        
        <p>Construct a new rule and pass it a reference to us</p>

        
          <div class='highlight'><pre>  rule: ( name, fn ) -&gt;
    rule = <span class="keyword">new</span> Rule( name, fn )
    <span class="property">@_rules</span>[name] = rule
    rule.constructor.f = @
    <span class="keyword">return</span> rule</pre></div>
        
      
        
        <h3>Helpers</h3>

        
          <div class='highlight'><pre>Array::<span class="function"><span class="title">remove</span></span> = (object) -&gt; <span class="property">@splice</span>(<span class="property">@indexOf</span>(object), <span class="number">1</span>)
Array::<span class="function"><span class="title">clone</span></span> = -&gt; @[..]</pre></div>
        
      
        
        <h3>Export Funnel</h3>

        
          <div class='highlight'><pre><span class="property">@Funnel</span> = Funnel
module?.exports = Funnel</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
